{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock title %}
{% block css %}
<link rel="stylesheet" href="{% static 'analysis/css/dashboard.css' %}">
<!-- Mapbox cdn -->
<script src='https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js'></script>
<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css'/>
<!-- Mapbox draw cdn plugin -->
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css" type="text/css">
{% endblock css %}

{% block content %}
<header>
    <form action="{% url 'logout' %}" method="post">
        {% csrf_token %}
        <button type="submit" class="btn btn--m">Log out</button>
    </form>
</header>
<div id="dashboard--contanier">
    <div id="map"></div>
</div>
{{ access_token|json_script:'token-data'}}
<script>
    const token = JSON.parse(document.getElementById('token-data').textContent);
    const csrftoken = getCookie('csrftoken');

    mapboxgl.accessToken = token;
    if (!mapboxgl.supported()) {
        alert("Your browser does not support Mapbox GL");
    } else {
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/satellite-streets-v12',
            center: [36.8219, -1.2921],
            zoom: 12
        });

        var draw = new MapboxDraw({
            displayControlsDefault: false,
            controls: {
                polygon: true,
                trash: true,
            },
            defaultMode: 'draw_polygon',
        })

        map.addControl(draw);
        map.on('draw.create', saveCoord);
    }

    function getCookie(name){
        return document.cookie.match(name).input.split('=').pop();
    }

    async function saveCoord(e) {
        const data = draw.getAll();
        if (data.features.length > 0) {
            const res = await fetch("{% url 'analysis:dashboard' %}", {
                method: "POST",
                body: JSON.stringify(data),
                headers: {
                    'Accept': "application/json",
                    'Content-Type': "application/json",
                    'X-Requested-With': 'XMLHttpRequest',
                    "X-CSRFToken": csrftoken,
                }
            });
            if(res.ok){
                console.log("Data below sent to backend");
                console.log(data);
            }
        }
    }
</script>
<!-- <script type="module" src="{% static 'index-bundle.js' %}"></script> -->
{% endblock content %}